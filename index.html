<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Slipper Multiplayer</title>
<style>
  body { margin:0; overflow:hidden; background:#333; }
  canvas { display:block; margin:0 auto; background:#222; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 800;
canvas.height = 600;

const speed = 4;
let player = { x: 400, y: 300, color: "cyan", id: null, hp: 100 };
let bullets = [];
let otherPlayers = {};

let keys = {};

// ======= WebSocket =======
const WS_URL = "wss://ed-1-yazy.onrender.com"; // <-- Render WebSocket
const ws = new WebSocket(WS_URL);

ws.onopen = () => console.log("Connected to server");

ws.onmessage = msg => {
    const data = JSON.parse(msg.data);

    if (data.type === "init") {
        player.id = data.id;
        return;
    }

    if (data.type === "state") {
        if (data.playerId !== player.id) {
            otherPlayers[data.playerId] = data.state;
        }
    }

    if (data.type === "leave") {
        delete otherPlayers[data.playerId];
    }

    if (data.type === "hit") {
        if (data.playerId === player.id) {
            player.hp = data.hp;
        }
    }

    if (data.type === "dead") {
        if (data.playerId === player.id) {
            alert("You died!");
            player.x = 400;
            player.y = 300;
            player.hp = 100;
        }
    }
};

// ======= Controls =======
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

canvas.addEventListener("click", e => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    bullets.push({
        x: player.x,
        y: player.y,
        dx: (mx - player.x) / 20,
        dy: (my - player.y) / 20
    });
});

// ======= Game Logic =======
function update() {
    if (keys["ArrowUp"] || keys["w"]) player.y -= speed;
    if (keys["ArrowDown"] || keys["s"]) player.y += speed;
    if (keys["ArrowLeft"] || keys["a"]) player.x -= speed;
    if (keys["ArrowRight"] || keys["d"]) player.x += speed;

    // Move bullets
    bullets.forEach(b => { b.x += b.dx; b.y += b.dy; });

    // Remove off-screen bullets
    bullets = bullets.filter(b =>
        b.x > 0 && b.x < canvas.width && b.y > 0 && b.y < canvas.height
    );

    // Detect bullet hits
    for (let id in otherPlayers) {
        const p = otherPlayers[id];

        bullets.forEach(b => {
            if (Math.abs(b.x - p.x) < 15 && Math.abs(b.y - p.y) < 15) {

                ws.send(JSON.stringify({
                    type: "hit",
                    target: id,
                    damage: 20
                }));

                b.x = -999;
            }
        });
    }

    // Send update
    if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
            type: "update",
            state: { x: player.x, y: player.y, bullets }
        }));
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw self
    ctx.fillStyle = "cyan";
    ctx.fillRect(player.x - 10, player.y - 10, 20, 20);

    // HP
    ctx.fillStyle = "white";
    ctx.font = "20px Arial";
    ctx.fillText("HP: " + player.hp, 20, 30);

    // Bullets
    bullets.forEach(b => {
        ctx.fillStyle = "yellow";
        ctx.fillRect(b.x - 5, b.y - 5, 10, 10);
    });

    // Other players
    for (let id in otherPlayers) {
        const p = otherPlayers[id];
        ctx.fillStyle = "red";
        ctx.fillRect(p.x - 10, p.y - 10, 20, 20);

        if (p.bullets) {
            p.bullets.forEach(b => {
                ctx.fillStyle = "orange";
                ctx.fillRect(b.x - 5, b.y -5, 10, 10);
            });
        }
    }
}

// ======= Main Loop =======
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>

